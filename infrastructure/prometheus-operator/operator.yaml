---
# HelmRelease for Prometheus Operator
# Installs the operator that manages Prometheus, ServiceMonitor, and related CRDs
#
# The operator watches cluster-wide for:
# - Prometheus: defines a Prometheus deployment
# - ServiceMonitor: defines what services to scrape
# - PodMonitor: defines what pods to scrape directly
# - Probe: defines blackbox exporter probes
# - PrometheusRule: defines alerting/recording rules
# - AlertmanagerConfig: defines alertmanager configuration
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: prometheus-operator
  namespace: flux-system
spec:
  interval: 10m
  chart:
    spec:
      chart: prometheus-operator
      version: '>=9.0.0 <10.0.0'  # Use latest 9.x version
      sourceRef:
        kind: HelmRepository
        name: prometheus-community
        namespace: flux-system
      interval: 1h

  # Install into dedicated operator namespace
  targetNamespace: prometheus-operator
  install:
    createNamespace: true
    # CRDs are installed by default with this chart
    # This is what we want - let Helm manage the CRD lifecycle
    remediation:
      retries: 3
  upgrade:
    # Important: CRDs are NOT automatically upgraded by Helm by default
    # The chart includes a crds/ directory that Helm installs but doesn't upgrade
    # For production you'd want a separate CRD management strategy
    # For learning, this is fine - we'll manually apply CRD updates if needed
    remediation:
      retries: 3

  values:
    # Operator watches ALL namespaces by default (cluster-wide)
    # This means ServiceMonitors can be created anywhere and will be discovered
    # If you wanted to limit to specific namespaces:
    # namespaces:
    #   - monitoring
    #   - default

    # The operator itself needs minimal resources
    resources:
      limits:
        cpu: 200m
        memory: 256Mi
      requests:
        cpu: 100m
        memory: 128Mi

    # Prometheus Operator includes a prometheus-config-reloader sidecar
    # that watches for ConfigMap changes and reloads Prometheus
    # We can set resource limits for this too
    prometheusConfigReloader:
      resources:
        limits:
          cpu: 100m
          memory: 50Mi
        requests:
          cpu: 50m
          memory: 25Mi

    # Enable admission webhooks for validating Prometheus resources
    # This validates your Prometheus/ServiceMonitor CRs before they're created
    admissionWebhooks:
      enabled: true
      # Patch job creates the webhook certificates
      patch:
        resources:
          limits:
            cpu: 100m
            memory: 50Mi
          requests:
            cpu: 50m
            memory: 25Mi
