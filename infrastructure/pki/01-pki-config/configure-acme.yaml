---
# Automated ACME provisioner configuration for step-ca
# This Job waits for step-ca to be ready, then adds the ACME provisioner
# Designed to be idempotent and self-healing
apiVersion: batch/v1
kind: Job
metadata:
  name: step-ca-configure-acme
  namespace: step-ca
spec:
  # Keep job for 1 hour after completion for debugging
  ttlSecondsAfterFinished: 3600
  # Retry up to 5 times if it fails
  backoffLimit: 5
  template:
    metadata:
      labels:
        app: step-ca-config
    spec:
      restartPolicy: OnFailure
      serviceAccountName: default
      containers:
        - name: configure-acme
          image: cr.smallstep.com/smallstep/step-cli:latest
          command:
            - /bin/sh
            - -c
            - |
              set -e

              echo "=== Step CA ACME Provisioner Configuration ==="
              echo "Waiting for step-ca to be ready..."

              # Wait up to 5 minutes for step-ca to be healthy
              TIMEOUT=300
              ELAPSED=0
              until step ca health --ca-url https://step-ca.step-ca.svc.cluster.local --root /home/step/certs/root_ca.crt 2>/dev/null; do
                if [ $ELAPSED -ge $TIMEOUT ]; then
                  echo "ERROR: step-ca did not become healthy within ${TIMEOUT}s"
                  exit 1
                fi
                echo "step-ca not ready yet (${ELAPSED}s/${TIMEOUT}s), waiting..."
                sleep 5
                ELAPSED=$((ELAPSED + 5))
              done

              echo "✓ step-ca is healthy!"
              echo ""

              # List current provisioners
              echo "Current provisioners:"
              step ca provisioner list \
                --ca-url https://step-ca.step-ca.svc.cluster.local \
                --root /home/step/certs/root_ca.crt || true
              echo ""

              # Check if ACME provisioner already exists
              if step ca provisioner list \
                --ca-url https://step-ca.step-ca.svc.cluster.local \
                --root /home/step/certs/root_ca.crt 2>/dev/null | grep -q "acme (ACME)"; then
                echo "✓ ACME provisioner already exists, nothing to do"
                exit 0
              fi

              echo "Adding ACME provisioner..."

              # Add ACME provisioner using admin credentials
              step ca provisioner add acme \
                --type ACME \
                --ca-url https://step-ca.step-ca.svc.cluster.local \
                --root /home/step/certs/root_ca.crt \
                --admin-cert /home/step/certs/root_ca.crt \
                --admin-key /home/step/secrets/intermediate_ca_key \
                --admin-provisioner admin \
                --admin-subject "" \
                --admin-password-file /home/step/secrets/password

              echo ""
              echo "✓ ACME provisioner added successfully!"
              echo ""

              # Verify by listing provisioners again
              echo "Updated provisioners:"
              step ca provisioner list \
                --ca-url https://step-ca.step-ca.svc.cluster.local \
                --root /home/step/certs/root_ca.crt

              echo ""
              echo "=== Configuration Complete ==="
          volumeMounts:
            - name: certs
              mountPath: /home/step/certs
              readOnly: true
            - name: secrets
              mountPath: /home/step/secrets
              readOnly: true
      volumes:
        - name: certs
          configMap:
            name: step-ca-step-ca-step-certificates-certs
        - name: secrets
          projected:
            sources:
              - configMap:
                  name: step-ca-step-ca-step-certificates-secrets
              - secret:
                  name: step-ca-step-ca-step-certificates-ca-password
